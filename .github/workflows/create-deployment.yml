name: Create Deployment (example)
# touch: reindex workflows â€” updated by GitHub Copilot to force workflow_dispatch reindex on GitHub

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment (e.g. production, staging, review)'
        required: false
        default: 'production'
      ref:
        description: 'Ref to deploy (branch, tag, or SHA). Defaults to the commit that triggered the run.'
        required: false
      transient:
        description: 'If true, marks the environment as transient (e.g. review app)'
        required: false
        default: 'false'
      description:
        description: 'Human friendly description to show on the deployment'
        required: false
      task:
        description: 'Deployment task name (defaults to "deploy")'
        required: false
        default: 'deploy'
      test_only:
        description: 'If true, mark deployment success without running the actual deployment (for testing integrations)'
        required: false
        default: 'false'

permissions:
  contents: read
  deployments: write

jobs:
  create-deploy:
    name: Create and run deployment
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create GitHub deployment (using chrnorm/deployment-action)
        id: create_deployment
        uses: chrnorm/deployment-action@v2
        with:
          token: ${{ github.token }}
          # Environment name (defaults to 'production')
          environment: ${{ github.event.inputs.environment || 'production' }}
          # Human friendly description
          description: ${{ github.event.inputs.description || 'Deployment from GitHub Actions' }}
          # The ref to deploy: branch, tag, or SHA
          ref: ${{ github.event.inputs.ref || github.sha }}
          # Task name
          task: ${{ github.event.inputs.task || 'deploy' }}
          # Mark as transient environment if requested
          transient-environment: ${{ github.event.inputs.transient || 'false' }}
          # Treat 'production' as a production environment by default
          production-environment: ${{ github.event.inputs.environment == 'production' }}
          initial-status: pending

      - name: Test-only: mark deployment as successful (no-op)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.test_only == 'true' }}
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ github.token }}
          deployment-id: ${{ steps.create_deployment.outputs.deployment_id }}
          environment-url: ${{ steps.create_deployment.outputs.environment_url }}
          state: success

      - name: Demo deploy step (replace with your real deploy)
        if: ${{ !(github.event_name == 'workflow_dispatch' && github.event.inputs.test_only == 'true') }}
        run: |
          echo "Running demo deploy for ${{ steps.create_deployment.outputs.deployment_id }}"
          # Here is where you would run rsync, kubectl, etc.
          sleep 1

      - name: Mark deployment as successful
        if: success()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ github.token }}
          deployment-id: ${{ steps.create_deployment.outputs.deployment_id }}
          environment-url: ${{ steps.create_deployment.outputs.environment_url }}
          state: success

      - name: Mark deployment as failed
        if: failure()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ github.token }}
          deployment-id: ${{ steps.create_deployment.outputs.deployment_id }}
          environment-url: ${{ steps.create_deployment.outputs.environment_url }}
          state: failure
